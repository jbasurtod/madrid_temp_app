<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentiment Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/voiceanalysis.css') }}">
    <!-- Google Font link for "Nerko One" -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nerko+One&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <!-- Replace image with styled text -->
        <h1 class="title">Call üòµ‚Äçüí´ Mood</h1>
    </header>
    <div id="initial-view" class="content-box">
        <h1>Enter ID to Begin</h1>
        <div class="input-container">
            <input type="text" id="id-input" placeholder="Enter ID here">
            <button onclick="handleIDSubmit()">Submit</button>
        </div>
    </div>
    <div id="main-view" class="content-box hidden">
        <h1 id="main-title">Sentiment Analysis for ID: </h1>
        <div id="info">
            <div id="text">Text: Waiting for data...</div>
            <div id="sentiment-label">Sentiment: Waiting for data...</div>
            <div id="sentiment-score">Score: Waiting for data...</div>
            <div id="error-message"></div> <!-- To show error messages -->
        </div>
        <!-- Button to analyze another call -->
        <div id="reload-container" class="hidden">
            <button onclick="reloadPage()" style="margin-top:40px;">Analyze another call</button>
        </div>
    </div>

    <script>
        let currentID = null;
        let pollingInterval = null;

        function handleIDSubmit() {
            const idInput = document.getElementById('id-input').value;
            if (idInput) {
                currentID = idInput;
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('main-view').classList.remove('hidden');
                document.getElementById('main-title').innerText = `Sentiment Analysis for ID: ${currentID}`; // Update title with ID

                // Stop any previous polling
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }

                // Start polling immediately
                startPolling(currentID);
            } else {
                alert('Please enter a valid ID.');
            }
        }

        function startPolling(analysisID) {
            // Poll immediately
            fetchAndUpdate(analysisID);

            // Continue polling every 3 seconds
            pollingInterval = setInterval(() => {
                fetchAndUpdate(analysisID);
            }, 3000); // Poll every 3 seconds
        }

        async function fetchAndUpdate(analysisID) {
            try {
                const response = await fetch(`/get-analysis-data?id=${analysisID}`);
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error('Polling error:', error);
                document.getElementById("error-message").innerHTML = "Error: Unable to fetch data. Retrying...";
            }
        }

        function updateUI(data) {
            const titleElement = document.querySelector('.title'); // Select the title element
            let emoji = ''; // Initialize emoji variable

            if (data.error) {
                document.getElementById("error-message").innerHTML = "Error: " + data.error;
                return;
            }

            if (data.status === "not yet created") {
                // Handle "not yet created" status
                document.getElementById("text").innerHTML = "Status: " + data.status;
                document.getElementById("sentiment-label").innerHTML = "";
                document.getElementById("sentiment-score").innerHTML = "";
                emoji = 'üßê'; // Question mark emoji for unknown status
                document.getElementById("reload-container").classList.add('hidden'); // Hide the reload button
            } else if (data.status === "recording") {
                // Handle "recording" status
                document.getElementById("text").innerHTML = "Status: <span class='status-recording'>Recording</span>";
                emoji = 'üé§'; // Microphone emoji for recording
                document.getElementById("reload-container").classList.add('hidden'); // Hide the reload button
            } else if (data.status === "processing") {
                // Handle "processing" status
                document.getElementById("text").innerHTML = "Status: <span class='status-processing'>Processing</span>";
                emoji = '‚è≥'; // Hourglass emoji for processing
                document.getElementById("reload-container").classList.add('hidden'); // Hide the reload button
            } else if (data.status === "done") {
                // Handle "done" status and sentiment results
                document.getElementById("text").innerHTML = "Text: " + data.text;
                const sentimentLabel = data.sentiment[0].label;
                const sentimentDiv = document.getElementById("sentiment-label");

                if (sentimentLabel === 'POS') {
                    sentimentDiv.innerHTML = "Sentiment: Positive";
                    sentimentDiv.className = "positive";
                    emoji = 'üòä'; // Happy emoji for positive sentiment
                } else if (sentimentLabel === 'NEG') {
                    sentimentDiv.innerHTML = "Sentiment: Negative";
                    sentimentDiv.className = "negative";
                    emoji = 'üò¢'; // Sad emoji for negative sentiment
                } else if (sentimentLabel === 'NEU') {
                    sentimentDiv.innerHTML = "Sentiment: Neutral";
                    sentimentDiv.className = "neutral";
                    emoji = 'üòê'; // Neutral face emoji for neutral sentiment
                }

                document.getElementById("sentiment-score").innerHTML =
                    "Score: " + data.sentiment[0].score.toFixed(3);
                
                // Show the reload button
                document.getElementById("reload-container").classList.remove('hidden');
            } else {
                // Handle other statuses if needed
                document.getElementById("text").innerHTML = "Status: " + data.status;
                document.getElementById("sentiment-label").innerHTML = "";
                document.getElementById("sentiment-score").innerHTML = "";
                emoji = '‚ùì'; // Question mark emoji for unknown status
                document.getElementById("reload-container").classList.add('hidden'); // Hide the reload button
            }

            // Update the title with the new emoji
            titleElement.innerHTML = `Call ${emoji} Mood`;
        }

        function reloadPage() {
            window.location.reload();
        }

        // Handle Enter key for submitting ID
        document.getElementById('id-input').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                handleIDSubmit();
            }
        });
    </script>
</body>
</html>
